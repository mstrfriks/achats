<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
 background:#f5f5f7;
 margin:40px;
}
.card{
 background:white;
 border-radius:18px;
 padding:20px;
 margin-bottom:20px;
 box-shadow:0 4px 20px rgba(0,0,0,.06);
}
input,select,button{
 padding:8px;
 border-radius:10px;
 border:1px solid #ddd;
 margin:4px;
}
button{
 background:#0071e3;
 color:white;
 border:none;
 cursor:pointer;
}
table{
 width:100%;
 border-collapse:collapse;
 background:white;
}
th,td{
 padding:10px;
 border-bottom:1px solid #eee;
}
th{background:#fafafa;cursor:pointer}
.kpi{font-size:22px;font-weight:600}
.action-btn{font-size:12px;margin-right:6px}
</style>
</head>

<body>

<h2>üìä Suivi des achats</h2>

<!-- AJOUT -->
<div class="card">
<b>Ajouter une ligne</b><br>
<input id="addF" placeholder="Fournisseur">
<input id="addDate" placeholder="Date jj/mm/aaaa">
<input id="addCom" placeholder="Commentaire">
<input id="addHt" placeholder="Montant ‚Ç¨">
<input id="addType" placeholder="Type">
<input id="addRef" placeholder="R√©f">
<button onclick="addRow()">Ajouter</button>
</div>

<!-- FILTRES -->
<div class="card">
<select id="fFilter"><option value="">Tous fournisseurs</option></select>
<select id="yearFilter"><option value="">Toutes ann√©es</option></select>
<select id="monthFilter"><option value="">Tous mois</option></select>
</div>

<div class="card kpi">
Total HT : <span id="total">0 ‚Ç¨</span>
</div>

<div class="card">
<canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
<th data-col="0">Fournisseur</th>
<th data-col="1">Date</th>
<th data-col="2">Commentaire</th>
<th data-col="3">‚Ç¨ HT</th>
<th data-col="4">Type</th>
<th data-col="5">R√©f</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>

const MONTHS=["jan","f√©v","mar","avr","mai","jun","jul","ao√ª","sep","oct","nov","d√©c"];

function eur(v){
 return parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", "."))||0;
}

function cleanRef(v){
 v=(v||"").trim();
 return v?v:"Sans r√©f√©rence";
}

function parseDate(d){
 if(!d||!d.includes("/")) return {};
 const [j,m,a]=d.split("/");
 return {j:+j,m:+m,a:+a};
}

function monthKey(d){
 const p=parseDate(d);
 if(!p.a) return null;
 return p.a+"-"+String(p.m).padStart(2,"0");
}

function dateValue(d){
 const p=parseDate(d);
 return p.a ? new Date(p.a,p.m-1,p.j).getTime() : 0;
}

let DATA=[];
let sortCol=1, sortDir=-1;
let chart;

function addRow(){

 const f=addF.value.trim();
 const d=addDate.value.trim();
 const c=addCom.value.trim();
 const ht=addHt.value.trim();
 const t=addType.value.trim();
 const r=cleanRef(addRef.value);

 if(!f||!d||!ht){ alert("Fournisseur, date, montant requis"); return; }

 DATA.push({
   f, ref:r,
   y:parseDate(d).a,
   m:parseDate(d).m,
   month:monthKey(d),
   arr:[f,d,c,ht,t,r]
 });

 refreshFilters();
 render();
}

function refreshFilters(){

 const fset=new Set();
 const yset=new Set();
 const mset=new Set();

 DATA.forEach(x=>{
   fset.add(x.f);
   if(x.y) yset.add(x.y);
   if(x.m) mset.add(x.m);
 });

 fFilter.innerHTML='<option value="">Tous fournisseurs</option>'+
   [...fset].sort().map(v=>`<option>${v}</option>`).join("");

 yearFilter.innerHTML='<option value="">Toutes ann√©es</option>'+
   [...yset].sort().map(v=>`<option>${v}</option>`).join("");

 monthFilter.innerHTML='<option value="">Tous mois</option>'+
   [...mset].sort((a,b)=>a-b).map(v=>`<option value="${v}">${MONTHS[v-1]}</option>`).join("");
}

function getFiltered(){

 const f=fFilter.value;
 const y=yearFilter.value;
 const m=monthFilter.value;

 return DATA.filter(x =>
   (!f || x.f===f) &&
   (!y || x.y==y) &&
   (!m || x.m==m)
 );
}

function render(){

 const rows=getFiltered();

 rows.sort((a,b)=>{
   if(sortCol===3) return (eur(a.arr[3])-eur(b.arr[3]))*sortDir;
   if(sortCol===1) return (dateValue(a.arr[1])-dateValue(b.arr[1]))*sortDir;
   return a.arr[sortCol].localeCompare(b.arr[sortCol],"fr")*sortDir;
 });

 tbody.innerHTML="";
 let total=0;

 rows.forEach((x,i)=>{
   total+=eur(x.arr[3]);
   tbody.innerHTML+=`
   <tr>
     <td>${x.arr[0]}</td>
     <td>${x.arr[1]}</td>
     <td>${x.arr[2]}</td>
     <td>${x.arr[3]}</td>
     <td>${x.arr[4]}</td>
     <td>${x.arr[5]}</td>
     <td>
       <button class="action-btn" onclick="editRow(${DATA.indexOf(x)})">‚úèÔ∏è</button>
       <button class="action-btn" onclick="deleteRow(${DATA.indexOf(x)})">üóë</button>
     </td>
   </tr>`;
 });

 totalEl.textContent=total.toLocaleString()+" ‚Ç¨";
 buildChart(rows);
}

function editRow(i){
 const r=DATA[i].arr;
 tbody.children[i].innerHTML=`
<td><input value="${r[0]}"></td>
<td><input value="${r[1]}"></td>
<td><input value="${r[2]}"></td>
<td><input value="${r[3]}"></td>
<td><input value="${r[4]}"></td>
<td><input value="${r[5]}"></td>
<td><button onclick="saveRow(${i})">üíæ</button></td>`;
}

function saveRow(i){
 const inputs=tbody.children[i].querySelectorAll("input");
 const a=[...inputs].map(x=>x.value);
 DATA[i]={
   f:a[0], ref:cleanRef(a[5]),
   y:parseDate(a[1]).a,
   m:parseDate(a[1]).m,
   month:monthKey(a[1]),
   arr:[a[0],a[1],a[2],a[3],a[4],cleanRef(a[5])]
 };
 refreshFilters();
 render();
}

function deleteRow(i){
 if(!confirm("Supprimer cette ligne ?")) return;
 DATA.splice(i,1);
 refreshFilters();
 render();
}

function buildChart(rows){

 const map={};

 rows.forEach(r=>{
   if(!r.month) return;
   if(!map[r.month]) map[r.month]={};
   map[r.month][r.ref]=(map[r.month][r.ref]||0)+eur(r.arr[3]);
 });

 const months=Object.keys(map).sort();
 const labels=months.map(k=>{
   const [a,m]=k.split("-");
   return MONTHS[m-1]+" "+a;
 });

 const refs=[...new Set(rows.map(r=>r.ref))];

 const datasets=refs.map(ref=>({
   label:ref,
   data:months.map(m=>map[m][ref]||0)
 }));

 if(chart) chart.destroy();

 chart=new Chart(chartEl,{
   type:"bar",
   data:{labels,datasets},
   options:{scales:{x:{stacked:true},y:{stacked:true}}}
 });
}

fetch("data.csv")
.then(r=>r.text())
.then(csv=>Papa.parse(csv,{
 skipEmptyLines:true,
 complete: res => {

   res.data.slice(2).forEach(row=>{
     if(!row[0]) return;
     const d=row[1];
     const p=parseDate(d);

     DATA.push({
       f:row[0],
       ref:cleanRef(row[7]),
       y:p.a,
       m:p.m,
       month:monthKey(d),
       arr:[row[0],row[1],row[2],row[3],row[6],cleanRef(row[7])]
     });
   });

   refreshFilters();
   render();
 }
}));

document.querySelectorAll("th").forEach(th=>{
 th.onclick=()=>{sortCol=+th.dataset.col;sortDir*=-1;render();}
});

fFilter.onchange=render;
yearFilter.onchange=render;
monthFilter.onchange=render;

const tbody=document.getElementById("tbody");
const totalEl=document.getElementById("total");
const chartEl=document.getElementById("chart");

</script>

</body>
</html>
