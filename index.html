<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi achats V3 fast</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,Segoe UI,Arial;background:#f5f5f7;margin:30px}
.card{background:white;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee}
button{padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#0071e3;color:white}
input{padding:6px;border-radius:8px;border:1px solid #ddd}
</style>
</head>

<body>

<div class="card">
<input id="addF" placeholder="Fournisseur">
<input id="addDate" placeholder="Date">
<input id="addHt" placeholder="Montant">
<input id="addRef" placeholder="Ref">
<button onclick="addRow()">Ajouter</button>
</div>

<div class="card">Total : <b id="total"></b></div>
<div class="card"><canvas id="chart"></canvas></div>

<table>
<thead>
<tr>
<th>Fournisseur</th><th>Date</th><th>‚Ç¨</th><th>Ref</th><th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>

/* ========= FAST STORAGE CACHE ========= */

const DATA_KEY="fast_data"
let DATA = JSON.parse(localStorage.getItem(DATA_KEY)||"[]")
let chart=null
let lastHash=""

/* ========= UTILS ========= */

const eur = v => parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", "."))||0

function monthKey(d){
 if(!d.includes("/")) return null
 const [j,m,a]=d.split("/")
 return a+"-"+m
}

/* ========= DATA OPS ========= */

function saveData(){
 localStorage.setItem(DATA_KEY,JSON.stringify(DATA))
}

function addRow(){
 const f=addF.value,d=addDate.value,ht=addHt.value,r=addRef.value||"Sans r√©f√©rence"
 DATA.push({arr:[f,d,ht,r],month:monthKey(d),ref:r})
 saveData()
 renderFast()
}

function deleteRow(i){
 if(!confirm("Supprimer ?")) return
 DATA.splice(i,1)
 saveData()
 renderFast()
}

/* ========= FAST RENDER ========= */

function renderFast(){

 /* ----- TABLE ----- */

 let total=0
 let html=""

 for(let i=0;i<DATA.length;i++){
  const r=DATA[i]
  total+=eur(r.arr[2])
  html+=`<tr>
   <td>${r.arr[0]}</td>
   <td>${r.arr[1]}</td>
   <td>${r.arr[2]}</td>
   <td>${r.arr[3]}</td>
   <td><button onclick="deleteRow(${i})">üóë</button></td>
  </tr>`
 }

 tbody.innerHTML=html
 totalEl.textContent=total.toLocaleString()+" ‚Ç¨"

 /* ----- CHART (hash change only) ----- */

 const hash = DATA.length + "-" + total
 if(hash===lastHash) return
 lastHash=hash

 const map={}
 for(const r of DATA){
  if(!r.month) continue
  if(!map[r.month]) map[r.month]={}
  map[r.month][r.ref]=(map[r.month][r.ref]||0)+eur(r.arr[2])
 }

 const months=Object.keys(map).sort()
 const refs=[...new Set(DATA.map(x=>x.ref))]

 const datasets=refs.map(ref=>({
   label:ref,
   data:months.map(m=>map[m][ref]||0)
 }))

 if(chart) chart.destroy()

 chart=new Chart(chartEl,{
   type:"bar",
   data:{labels:months,datasets},
   options:{animation:false,scales:{x:{stacked:true},y:{stacked:true}}}
 })
}

/* ========= CSV LOAD ========= */

fetch("data.csv")
.then(r=>r.text())
.then(csv=>{
 Papa.parse(csv,{
  skipEmptyLines:true,
  complete: res=>{
   for(const row of res.data.slice(2)){
    if(!row[0]) continue
    DATA.push({
      arr:[row[0],row[1],row[3],row[7]||"Sans r√©f√©rence"],
      month:monthKey(row[1]),
      ref:row[7]||"Sans r√©f√©rence"
    })
   }
   saveData()
   renderFast()
  }
 })
})

renderFast()

</script>
</body>
</html>
