<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,Segoe UI,Arial;background:#f5f5f7;margin:40px}
.tabs button{padding:10px 16px;border-radius:10px;border:1px solid #ddd;background:white;cursor:pointer;margin-right:8px}
.tab{display:none}
.tab.active{display:block}
.card{background:white;border-radius:18px;padding:20px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
input,select,button{padding:8px;border-radius:10px;border:1px solid #ddd;margin:4px}
table{width:100%;border-collapse:collapse;background:white}
th,td{padding:10px;border-bottom:1px solid #eee}
th{background:#fafafa}
</style>
</head>

<body>

<div class="tabs">
<button onclick="showTab('achats')">Achats</button>
<button onclick="showTab('refs')">R√©f√©rences</button>
</div>

<!-- ================= ACHATS ================= -->

<div id="achats" class="tab active">

<div class="card">
<b>Ajouter ligne</b><br>
<input id="addF" placeholder="Fournisseur">
<input id="addDate" placeholder="Date jj/mm/aaaa">
<input id="addCom" placeholder="Commentaire">
<input id="addHt" placeholder="Montant ‚Ç¨">
<input id="addType" placeholder="Type">
<select id="addRefSelect"></select>
<button onclick="addRow()">‚ûï Ajouter</button>
</div>

<div class="card">Total : <b id="total"></b></div>
<div class="card"><canvas id="chart"></canvas></div>

<table>
<thead>
<tr>
<th>Fournisseur</th><th>Date</th><th>Commentaire</th>
<th>‚Ç¨</th><th>Type</th><th>R√©f</th><th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- ================= REFERENCES ================= -->

<div id="refs" class="tab">

<div class="card">
<input id="newRefCode" placeholder="Code">
<input id="newRefName" placeholder="D√©signation">
<button onclick="addReference()">‚ûï Ajouter</button>
</div>

<div class="card">
<table>
<thead>
<tr><th>Code</th><th>D√©signation</th><th></th></tr>
</thead>
<tbody id="refBody"></tbody>
</table>
</div>

</div>

<script>

/* ---------- tabs ---------- */

function showTab(id){
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"))
 document.getElementById(id).classList.add("active")
}

/* ---------- storage ---------- */

const REF_KEY="refs_v3"
let REFS = JSON.parse(localStorage.getItem(REF_KEY)||"{}")
function saveRefs(){localStorage.setItem(REF_KEY,JSON.stringify(REFS))}

/* ---------- utils ---------- */

const eur = v => parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", "."))||0
const cleanRef = v => (v||"").trim()||"Sans r√©f√©rence"

function monthKey(d){
 if(!d||!d.includes("/")) return null
 const [j,m,a]=d.split("/")
 return a+"-"+m
}

/* ---------- data ---------- */

let DATA=[]
let chart

/* ---------- references ---------- */

function ensureRef(code){
 if(!REFS[code]) REFS[code]=""
}

function refreshRefUI(){

 // table
 refBody.innerHTML = Object.entries(REFS).sort().map(([code,name])=>`
 <tr>
  <td contenteditable onblur="editRefCode('${code}',this.innerText)">${code}</td>
  <td contenteditable onblur="editRefName('${code}',this.innerText)">${name}</td>
  <td><button onclick="deleteRef('${code}')">üóë</button></td>
 </tr>`).join("")

 // select
 addRefSelect.innerHTML = Object.keys(REFS).sort()
  .map(c=>`<option>${c}</option>`).join("")

 saveRefs()
}

function addReference(){
 const c=newRefCode.value.trim()
 if(!c) return
 if(REFS[c]){alert("R√©f√©rence d√©j√† existante");return}
 REFS[c]=newRefName.value.trim()
 refreshRefUI()
}

function deleteRef(code){
 if(!confirm("Supprimer r√©f√©rence ?")) return
 delete REFS[code]
 DATA.forEach(r=>{ if(r.ref===code) r.ref="Sans r√©f√©rence"; r.arr[5]=r.ref })
 refreshRefUI()
 render()
}

function editRefName(code,val){
 REFS[code]=val.trim()
 saveRefs()
}

function editRefCode(oldCode,newCode){

 newCode=newCode.trim()
 if(!newCode) return
 if(newCode!==oldCode && REFS[newCode]){
   alert("Code d√©j√† existant"); refreshRefUI(); return
 }

 REFS[newCode]=REFS[oldCode]
 delete REFS[oldCode]

 DATA.forEach(r=>{
   if(r.ref===oldCode){
     r.ref=newCode
     r.arr[5]=newCode
   }
 })

 refreshRefUI()
 render()
}

/* ---------- achats ops ---------- */

function addRow(){
 const f=addF.value.trim()
 const d=addDate.value.trim()
 const c=addCom.value.trim()
 const ht=addHt.value.trim()
 const t=addType.value.trim()
 const r=addRefSelect.value

 if(!f||!d||!ht){alert("Champs requis");return}

 DATA.push({arr:[f,d,c,ht,t,r],month:monthKey(d),ref:r})
 render()
}

/* ---------- rows edit ---------- */

function editRow(i){
 const r=DATA[i].arr
 tbody.children[i].innerHTML = `
<td><input value="${r[0]}"></td>
<td><input value="${r[1]}"></td>
<td><input value="${r[2]}"></td>
<td><input value="${r[3]}"></td>
<td><input value="${r[4]}"></td>
<td>${refSelectHTML(r[5])}</td>
<td><button onclick="saveRow(${i})">üíæ</button></td>`
}

function refSelectHTML(sel){
 return `<select>${
   Object.keys(REFS).map(k=>`<option ${k===sel?"selected":""}>${k}</option>`).join("")
 }</select>`
}

function saveRow(i){
 const cells=tbody.children[i].querySelectorAll("input,select")
 const a=[...cells].map(x=>x.value)
 DATA[i]={arr:a,month:monthKey(a[1]),ref:a[5]}
 render()
}

function deleteRow(i){
 if(!confirm("Supprimer ligne ?")) return
 DATA.splice(i,1)
 render()
}

/* ---------- render ---------- */

function render(){

 let total=0, html=""

 for(let i=0;i<DATA.length;i++){
  const r=DATA[i]
  total+=eur(r.arr[3])
  html+=`<tr>
   ${r.arr.map(v=>`<td>${v}</td>`).join("")}
   <td>
    <button onclick="editRow(${i})">‚úèÔ∏è</button>
    <button onclick="deleteRow(${i})">üóë</button>
   </td></tr>`
 }

 tbody.innerHTML=html
 totalEl.textContent=total.toLocaleString()+" ‚Ç¨"
 buildChart()
}

/* ---------- chart ---------- */

function buildChart(){

 const map={}
 for(const r of DATA){
  if(!r.month) continue
  if(!map[r.month]) map[r.month]={}
  map[r.month][r.ref]=(map[r.month][r.ref]||0)+eur(r.arr[3])
 }

 const months=Object.keys(map).sort()
 const refs=[...new Set(DATA.map(r=>r.ref))]

 const datasets=refs.map(ref=>({
  label:ref,
  data:months.map(m=>map[m][ref]||0)
 }))

 if(chart) chart.destroy()
 chart=new Chart(chartEl,{
  type:"bar",
  data:{labels:months,datasets},
  options:{animation:false,scales:{x:{stacked:true},y:{stacked:true}}}
 })
}

/* ---------- csv load ---------- */

fetch("data.csv")
.then(r=>r.text())
.then(csv=>Papa.parse(csv,{
 skipEmptyLines:true,
 complete: res => {

  res.data.slice(2).forEach(row=>{
   if(!row[0]) return
   const ref=cleanRef(row[7])
   ensureRef(ref)

   DATA.push({
    arr:[row[0],row[1],row[2],row[3],row[6],ref],
    month:monthKey(row[1]),
    ref
   })
  })

  refreshRefUI()
  render()
 }
}))

const tbody=document.getElementById("tbody")
const totalEl=document.getElementById("total")
const chartEl=document.getElementById("chart")

</script>
</body>
</html>
