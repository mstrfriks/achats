<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
 background:#f5f5f7;
 margin:40px;
 color:#1d1d1f;
}
.card{
 background:white;
 border-radius:18px;
 padding:20px;
 margin-bottom:20px;
 box-shadow:0 4px 20px rgba(0,0,0,.06);
}
input,select,button{
 padding:8px;
 border-radius:10px;
 border:1px solid #ddd;
}
button{
 cursor:pointer;
 background:#0071e3;
 color:white;
 border:none;
}
table{
 width:100%;
 border-collapse:collapse;
 background:white;
 border-radius:18px;
 overflow:hidden;
}
th,td{
 padding:10px;
 border-bottom:1px solid #eee;
}
th{background:#fafafa;cursor:pointer}
.kpi{font-size:22px;font-weight:600}
.action-btn{margin-right:6px;font-size:12px}
</style>
</head>

<body>

<h2>üìä Suivi des achats</h2>

<div class="card kpi">
Total HT filtr√© : <span id="total">0 ‚Ç¨</span>
</div>

<div class="card">
<canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
<th data-col="0">Fournisseur</th>
<th data-col="1">Date</th>
<th data-col="2">Commentaire</th>
<th data-col="3">‚Ç¨ HT</th>
<th data-col="4">Type</th>
<th data-col="5">R√©f</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>

function eur(v){
 return parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", ".")) || 0;
}

function cleanRef(v){
 v=(v||"").trim();
 return v?v:"Sans r√©f√©rence";
}

function dateValue(d){
 if(!d||!d.includes("/")) return 0;
 const [j,m,a]=d.split("/");
 return new Date(a,m-1,j).getTime();
}

function monthKey(d){
 if(!d||!d.includes("/")) return null;
 const [j,m,a]=d.split("/");
 return a+"-"+m;
}

function monthLabel(k){
 if(!k) return "";
 const [a,m]=k.split("-");
 const n=["jan","f√©v","mar","avr","mai","jun","jul","ao√ª","sep","oct","nov","d√©c"];
 return n[m-1]+" "+a;
}

let DATA=[];
let sortCol=1;
let sortDir=-1;
let chart;

function render(){

 const rows=[...DATA];

 rows.sort((a,b)=>{
   if(sortCol===3) return (eur(a.arr[3])-eur(b.arr[3]))*sortDir;
   if(sortCol===1) return (dateValue(a.arr[1])-dateValue(b.arr[1]))*sortDir;
   return (a.arr[sortCol]||"").localeCompare(b.arr[sortCol]||"","fr")*sortDir;
 });

 tbody.innerHTML="";
 let total=0;

 rows.forEach((x,i)=>{
   total+=eur(x.arr[3]);

   tbody.innerHTML+=`
   <tr>
     <td>${x.arr[0]}</td>
     <td>${x.arr[1]}</td>
     <td>${x.arr[2]}</td>
     <td>${x.arr[3]}</td>
     <td>${x.arr[4]}</td>
     <td>${x.arr[5]}</td>
     <td>
       <button class="action-btn" onclick="editRow(${i})">‚úèÔ∏è</button>
       <button class="action-btn" onclick="deleteRow(${i})">üóë</button>
     </td>
   </tr>`;
 });

 totalEl.textContent = total.toLocaleString()+" ‚Ç¨";
 buildChart(rows);
}

function editRow(i){

 const r=DATA[i].arr;

 tbody.children[i].innerHTML = `
<td><input value="${r[0]}"></td>
<td><input value="${r[1]}"></td>
<td><input value="${r[2]}"></td>
<td><input value="${r[3]}"></td>
<td><input value="${r[4]}"></td>
<td><input value="${r[5]}"></td>
<td>
<button onclick="saveRow(${i})">üíæ</button>
</td>`;
}

function saveRow(i){

 const inputs = tbody.children[i].querySelectorAll("input");
 const arr=[...inputs].map(x=>x.value);

 DATA[i]={
   f:arr[0],
   ref:cleanRef(arr[5]),
   month:monthKey(arr[1]),
   arr:[arr[0],arr[1],arr[2],arr[3],arr[4],cleanRef(arr[5])]
 };

 render();
}

function deleteRow(i){
 DATA.splice(i,1);
 render();
}

function buildChart(rows){

 const map={};

 rows.forEach(r=>{
   if(!r.month) return;
   if(!map[r.month]) map[r.month]={};
   map[r.month][r.ref]=(map[r.month][r.ref]||0)+eur(r.arr[3]);
 });

 const months=Object.keys(map).sort();
 const labels=months.map(monthLabel);
 const refs=[...new Set(rows.map(r=>r.ref))];

 const datasets=refs.map(ref=>({
   label:ref,
   data:months.map(m=>map[m][ref]||0)
 }));

 if(chart) chart.destroy();

 chart=new Chart(chartEl,{
   type:"bar",
   data:{labels,datasets},
   options:{scales:{x:{stacked:true},y:{stacked:true}}}
 });
}

fetch("data.csv")
.then(r=>r.text())
.then(csv=>Papa.parse(csv,{
 skipEmptyLines:true,
 complete: res => {

   res.data.slice(2).forEach(row=>{
     if(!row[0]) return;

     DATA.push({
       f:row[0],
       ref:cleanRef(row[7]),
       month:monthKey(row[1]),
       arr:[row[0],row[1],row[2],row[3],row[6],cleanRef(row[7])]
     });
   });

   render();
 }
}));

document.querySelectorAll("th").forEach(th=>{
 th.onclick=()=>{sortCol=+th.dataset.col;sortDir*=-1;render();}
});

const tbody=document.getElementById("tbody");
const totalEl=document.getElementById("total");
const chartEl=document.getElementById("chart");

</script>

</body>
</html>
