<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,Segoe UI,Arial;background:#f5f5f7;margin:30px}
.tabbar button{
 padding:10px 16px;
 border-radius:12px;
 border:1px solid #ddd;
 background:white;
 cursor:pointer;
 margin-right:8px;
}
.tab{display:none}
.tab.active{display:block}

.card{
 background:white;
 border-radius:16px;
 padding:16px;
 margin-bottom:16px;
 box-shadow:0 4px 16px rgba(0,0,0,.06);
}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee}
th{background:#fafafa}
input{padding:6px;border-radius:8px;border:1px solid #ddd}
.colorbox{width:16px;height:16px;border-radius:4px;display:inline-block}
</style>
</head>

<body>

<div class="tabbar">
<button onclick="showTab('achats')">üìä Achats</button>
<button onclick="showTab('refs')">üè∑ R√©f√©rences</button>
<button onclick="showTab('hist')">üïì Historique</button>
</div>

<!-- ================= ACHATS ================= -->

<div id="achats" class="tab active">

<div class="card">
<b>Ajouter ligne</b><br>
<input id="addF" placeholder="Fournisseur">
<input id="addDate" placeholder="Date jj/mm/aaaa">
<input id="addCom" placeholder="Commentaire">
<input id="addHt" placeholder="Montant">
<input id="addType" placeholder="Type">
<input id="addRef" placeholder="R√©f">
<button onclick="addRow()">Ajouter</button>
</div>

<div class="card">
Total : <b id="total">0 ‚Ç¨</b>
</div>

<div class="card">
<canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
<th>Fournisseur</th><th>Date</th><th>Commentaire</th>
<th>‚Ç¨</th><th>Type</th><th>R√©f</th><th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- ================= REFERENCES ================= -->

<div id="refs" class="tab">

<div class="card">
<b>Ajouter r√©f√©rence</b><br>
<input id="newRefCode" placeholder="Code">
<input id="newRefName" placeholder="D√©signation">
<button onclick="addRef()">Ajouter</button>
</div>

<table>
<thead><tr><th>Couleur</th><th>Code</th><th>D√©signation</th></tr></thead>
<tbody id="refBody"></tbody>
</table>

</div>

<!-- ================= HISTORIQUE ================= -->

<div id="hist" class="tab">
<table>
<thead><tr><th>Date</th><th>Action</th><th>D√©tail</th></tr></thead>
<tbody id="histBody"></tbody>
</table>
</div>

<script>

function showTab(id){
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"))
 document.getElementById(id).classList.add("active")
}

/* ================= STORAGE ================= */

const REF_STORE_KEY="refs_v1"
const HIST_STORE_KEY="hist_v1"

function loadRefs(){
 return JSON.parse(localStorage.getItem(REF_STORE_KEY)||"{}")
}
function saveRefs(r){
 localStorage.setItem(REF_STORE_KEY,JSON.stringify(r))
}

function loadHist(){
 return JSON.parse(localStorage.getItem(HIST_STORE_KEY)||"[]")
}
function saveHist(h){
 localStorage.setItem(HIST_STORE_KEY,JSON.stringify(h))
}

/* ================= COLORS ================= */

function colorFromString(s){
 let h=0;
 for(let i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h)
 return `hsl(${h%360},70%,55%)`
}

/* ================= DATA ================= */

let DATA=[]
let chart

function eur(v){
 return parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", "."))||0
}

function cleanRef(r){ return r&&r.trim()?r.trim():"Sans r√©f√©rence" }

function monthKey(d){
 if(!d.includes("/")) return null
 const [j,m,a]=d.split("/")
 return a+"-"+m
}

/* ================= HIST ================= */

function logHist(action,detail){
 const h=loadHist()
 h.unshift({t:new Date().toLocaleString(),action,detail})
 saveHist(h)
 renderHist()
}

function renderHist(){
 const h=loadHist()
 histBody.innerHTML=h.map(x=>`<tr><td>${x.t}</td><td>${x.action}</td><td>${x.detail}</td></tr>`).join("")
}

/* ================= REFERENCES ================= */

function addRef(){
 const code=newRefCode.value.trim()
 const name=newRefName.value.trim()
 if(!code) return
 const refs=loadRefs()
 refs[code]={name,color:colorFromString(code)}
 saveRefs(refs)
 logHist("REF ADD",code)
 renderRefs()
}

function renderRefs(){
 const refs=loadRefs()
 refBody.innerHTML=Object.entries(refs).map(([c,v])=>
 `<tr>
   <td><span class="colorbox" style="background:${v.color}"></span></td>
   <td>${c}</td>
   <td contenteditable onblur="editRefName('${c}',this.innerText)">${v.name||""}</td>
 </tr>`).join("")
}

function editRefName(code,name){
 const refs=loadRefs()
 refs[code].name=name
 saveRefs(refs)
 logHist("REF EDIT",code)
}

/* ================= ROWS ================= */

function addRow(){

 const f=addF.value
 const d=addDate.value
 const c=addCom.value
 const ht=addHt.value
 const t=addType.value
 const r=cleanRef(addRef.value)

 DATA.push({arr:[f,d,c,ht,t,r],month:monthKey(d),ref:r})

 logHist("ADD",`${f} ${ht}`)

 render()
}

function deleteRow(i){
 if(!confirm("Supprimer ?")) return
 logHist("DELETE",DATA[i].arr.join(" | "))
 DATA.splice(i,1)
 render()
}

function editRow(i){

 const r=DATA[i].arr
 tbody.children[i].innerHTML=r.map(v=>`<td><input value="${v}"></td>`).join("")+
 `<td><button onclick="saveRow(${i})">üíæ</button></td>`
}

function saveRow(i){

 const inputs=tbody.children[i].querySelectorAll("input")
 const old=DATA[i].arr.join(" | ")

 const arr=[...inputs].map(x=>x.value)

 DATA[i]={arr,month:monthKey(arr[1]),ref:cleanRef(arr[5])}

 logHist("EDIT",`${old} ‚Üí ${arr.join(" | ")}`)

 render()
}

/* ================= RENDER ================= */

function render(){

 let total=0
 tbody.innerHTML=""

 DATA.forEach((r,i)=>{
 total+=eur(r.arr[3])
 tbody.innerHTML+=`
 <tr>
  ${r.arr.map(v=>`<td>${v}</td>`).join("")}
  <td>
   <button onclick="editRow(${i})">‚úèÔ∏è</button>
   <button onclick="deleteRow(${i})">üóë</button>
  </td>
 </tr>`
 })

 totalEl.textContent=total.toLocaleString()+" ‚Ç¨"

 buildChart()
}

function buildChart(){

 const refs=loadRefs()
 const map={}

 DATA.forEach(r=>{
 if(!r.month) return
 if(!map[r.month]) map[r.month]={}
 map[r.month][r.ref]=(map[r.month][r.ref]||0)+eur(r.arr[3])
 })

 const months=Object.keys(map).sort()
 const labels=months

 const datasets=Object.keys(
 months.reduce((s,m)=>{Object.keys(map[m]).forEach(k=>s[k]=1);return s},{})
 ).map(ref=>({
   label:ref,
   data:months.map(m=>map[m][ref]||0),
   backgroundColor:(refs[ref]||{}).color || colorFromString(ref)
 }))

 if(chart) chart.destroy()

 chart=new Chart(chartEl,{
 type:"bar",
 data:{labels,datasets},
 options:{scales:{x:{stacked:true},y:{stacked:true}}}
 })
}

/* ================= LOAD CSV ================= */

fetch("data.csv")
.then(r=>r.text())
.then(csv=>Papa.parse(csv,{
 skipEmptyLines:true,
 complete: res=>{
  res.data.slice(2).forEach(row=>{
   if(!row[0]) return
   DATA.push({
     arr:[row[0],row[1],row[2],row[3],row[6],cleanRef(row[7])],
     month:monthKey(row[1]),
     ref:cleanRef(row[7])
   })
  })
  render()
 }
}))

/* ================= INIT ================= */

renderRefs()
renderHist()

</script>
</body>
</html>
