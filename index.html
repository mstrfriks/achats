<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
 background:#f5f5f7;
 margin:40px;
 color:#1d1d1f;
}
.card{
 background:white;
 border-radius:18px;
 padding:20px;
 margin-bottom:20px;
 box-shadow:0 4px 20px rgba(0,0,0,.06);
}
select{
 padding:10px;
 border-radius:12px;
 border:1px solid #ddd;
 margin-right:10px;
}
table{
 width:100%;
 border-collapse:collapse;
 background:white;
 border-radius:18px;
 overflow:hidden;
}
th,td{
 padding:10px;
 border-bottom:1px solid #eee;
}
th{
 cursor:pointer;
 background:#fafafa;
}
.kpi{
 font-size:22px;
 font-weight:600;
}
</style>
</head>

<body>

<h2>ðŸ“Š Suivi des achats</h2>

<div class="card">
<select id="fFilter"><option value="">Tous fournisseurs</option></select>
<select id="rFilter"><option value="">Toutes rÃ©fÃ©rences</option></select>
<select id="mFilter"><option value="">Tous mois</option></select>
</div>

<div class="card kpi">
Total HT filtrÃ© : <span id="total">0 â‚¬</span>
</div>

<div class="card">
<canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
<th data-col="0">Fournisseur</th>
<th data-col="1">Date</th>
<th data-col="2">Commentaire</th>
<th data-col="3">â‚¬ HT</th>
<th data-col="4">Type doc</th>
<th data-col="5">RÃ©f gestion</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>

function eur(v){
 return parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", ".")) || 0;
}

function norm(s){
 return (s||"").trim().toLowerCase();
}

function monthKey(d){
 if(!d || !d.includes("/")) return "";
 const [j,m,a]=d.split("/");
 return a+"-"+m;
}

let DATA=[];
let sortCol=1;
let sortDir=-1;
let chart;

function render(){

 const f = norm(fFilter.value);
 const r = norm(rFilter.value);
 const m = mFilter.value;

 const rows = DATA.filter(x =>
   (!f || norm(x.f)===f) &&
   (!r || norm(x.ref)===r) &&
   (!m || x.month===m)
 );

 rows.sort((a,b)=>{
   if(sortCol===3) return (eur(a.arr[3])-eur(b.arr[3]))*sortDir;
   return (a.arr[sortCol]||"").localeCompare(b.arr[sortCol]||"")*sortDir;
 });

 tbody.innerHTML="";
 let total=0;

 rows.forEach(x=>{
   total += eur(x.arr[3]);
   tbody.innerHTML += "<tr>"+x.arr.map(c=>`<td>${c||""}</td>`).join("")+"</tr>";
 });

 totalEl.textContent = total.toLocaleString()+" â‚¬";
 buildChart(rows);
}

function buildChart(rows){

 const map={};

 rows.forEach(r=>{
   if(!r.month) return;
   if(!map[r.month]) map[r.month]={};
   map[r.month][r.ref] = (map[r.month][r.ref]||0) + eur(r.arr[3]);
 });

 const months = Object.keys(map).sort();
 const refs = [...new Set(rows.map(r=>r.ref).filter(Boolean))];

 const datasets = refs.map(ref=>({
   label: ref,
   data: months.map(m => map[m][ref] || 0)
 }));

 if(chart) chart.destroy();

 chart = new Chart(chartEl,{
   type:"bar",
   data:{ labels:months, datasets },
   options:{
     responsive:true,
     plugins:{ legend:{ position:"bottom" }},
     scales:{ x:{ stacked:true }, y:{ stacked:true }}
   }
 });
}

fetch("data.csv")
.then(r=>r.text())
.then(csv => {

 Papa.parse(csv,{
  skipEmptyLines:true,
  complete: res => {

    const rows = res.data.slice(2); // saute titre + header

    const fset=new Set();
    const rset=new Set();
    const mset=new Set();

    rows.forEach(row=>{

      if(!row[0]) return;

      const d = row[1];
      const m = monthKey(d);

      const obj={
        f: row[0],
        ref: row[7],
        month: m,
        arr:[
          row[0],
          row[1],
          row[2],
          row[3],
          row[6],
          row[7]
        ]
      };

      DATA.push(obj);
      fset.add(obj.f);
      if(obj.ref) rset.add(obj.ref);
      if(m) mset.add(m);
    });

    [...fset].sort().forEach(v=>fFilter.innerHTML+=`<option>${v}</option>`);
    [...rset].sort().forEach(v=>rFilter.innerHTML+=`<option>${v}</option>`);
    [...mset].sort().forEach(v=>mFilter.innerHTML+=`<option>${v}</option>`);

    render();
  }
 });

});

document.querySelectorAll("th").forEach(th=>{
 th.onclick=()=>{
   sortCol=+th.dataset.col;
   sortDir*=-1;
   render();
 };
});

const tbody=document.getElementById("tbody");
const totalEl=document.getElementById("total");
const chartEl=document.getElementById("chart");
const fFilter=document.getElementById("fFilter");
const rFilter=document.getElementById("rFilter");
const mFilter=document.getElementById("mFilter");

fFilter.onchange=render;
rFilter.onchange=render;
mFilter.onchange=render;

</script>

</body>
</html>

