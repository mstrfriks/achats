<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
 background:#f5f5f7;
 margin:40px;
}
.tabs button{
 padding:10px 16px;
 border-radius:10px;
 border:1px solid #ddd;
 background:white;
 cursor:pointer;
 margin-right:8px;
}
.tab{display:none}
.tab.active{display:block}

.card{
 background:white;
 border-radius:18px;
 padding:20px;
 margin-bottom:20px;
 box-shadow:0 4px 20px rgba(0,0,0,.06);
}
input,select,button{
 padding:8px;
 border-radius:10px;
 border:1px solid #ddd;
 margin:4px;
}
table{
 width:100%;
 border-collapse:collapse;
 background:white;
}
th,td{
 padding:10px;
 border-bottom:1px solid #eee;
}
th{background:#fafafa;cursor:pointer}
.kpi{font-size:22px;font-weight:600}
</style>
</head>

<body>

<div class="tabs">
<button onclick="showTab('achats')">Achats</button>
<button onclick="showTab('refs')">Références</button>
</div>

<!-- ================= ACHATS ================= -->

<div id="achats" class="tab active">

<div class="card">
<b>Ajouter une ligne</b><br>
<input id="addF" placeholder="Fournisseur">
<input id="addDate" placeholder="Date jj/mm/aaaa">
<input id="addCom" placeholder="Commentaire">
<input id="addHt" placeholder="Montant €">
<input id="addType" placeholder="Type">
<input id="addRef" placeholder="Réf gestion">
<button onclick="addRow()">Ajouter</button>
</div>

<div class="card kpi">
Total HT filtré : <span id="total">0 €</span>
</div>

<div class="card">
<canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
<th data-col="0">Fournisseur</th>
<th data-col="1">Date</th>
<th data-col="2">Commentaire</th>
<th data-col="3">€ HT</th>
<th data-col="4">Type</th>
<th data-col="5">Réf</th>
<th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- ================= REFERENCES ================= -->

<div id="refs" class="tab">

<div class="card">
<table>
<thead>
<tr>
<th>Code</th>
<th>Désignation</th>
</tr>
</thead>
<tbody id="refBody"></tbody>
</table>
</div>

</div>

<script>

/* ---------- tabs ---------- */

function showTab(id){
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"))
 document.getElementById(id).classList.add("active")
}

/* ---------- refs storage ---------- */

const REF_KEY="ref_designations_v1"
let REF_DESIG = JSON.parse(localStorage.getItem(REF_KEY)||"{}")

function saveRefDesig(){
 localStorage.setItem(REF_KEY, JSON.stringify(REF_DESIG))
}

/* ---------- utils ---------- */

function eur(v){
 return parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", "."))||0;
}

function cleanRef(v){
 v=(v||"").trim();
 return v?v:"Sans référence";
}

function parseDate(d){
 if(!d||!d.includes("/")) return {};
 const [j,m,a]=d.split("/");
 return {j:+j,m:+m,a:+a};
}

function monthKey(d){
 const p=parseDate(d);
 if(!p.a) return null;
 return p.a+"-"+String(p.m).padStart(2,"0");
}

/* ---------- data ---------- */

let DATA=[];
let chart;

/* ---------- refs tab ---------- */

function refreshRefsTab(){

 const set = new Set(DATA.map(x=>x.ref));
 const rows = [...set].sort();

 refBody.innerHTML = rows.map(code=>{

   if(!REF_DESIG[code]) REF_DESIG[code]="";

   return `<tr>
     <td>${code}</td>
     <td contenteditable
         onblur="editRefDesig('${code}', this.innerText)">
         ${REF_DESIG[code]}
     </td>
   </tr>`;
 }).join("");

 saveRefDesig();
}

function editRefDesig(code,val){
 REF_DESIG[code]=val.trim();
 saveRefDesig();
}

/* ---------- achats ops ---------- */

function addRow(){

 const f=addF.value.trim();
 const d=addDate.value.trim();
 const c=addCom.value.trim();
 const ht=addHt.value.trim();
 const t=addType.value.trim();
 const r=cleanRef(addRef.value);

 if(!f||!d||!ht){
   alert("Fournisseur, date, montant requis");
   return;
 }

 DATA.push({
   f, ref:r, month:monthKey(d),
   arr:[f,d,c,ht,t,r]
 });

 render();
 refreshRefsTab();
}

function deleteRow(i){
 if(!confirm("Supprimer cette ligne ?")) return;
 DATA.splice(i,1);
 render();
 refreshRefsTab();
}

/* ---------- render ---------- */

function render(){

 let total=0;
 tbody.innerHTML="";

 DATA.forEach((x,i)=>{
   total+=eur(x.arr[3]);
   tbody.innerHTML+=`
   <tr>
     ${x.arr.map(v=>`<td>${v}</td>`).join("")}
     <td><button onclick="deleteRow(${i})">Supprimer</button></td>
   </tr>`;
 });

 totalEl.textContent=total.toLocaleString()+" €";
 buildChart();
}

/* ---------- chart ---------- */

function buildChart(){

 const map={};

 DATA.forEach(r=>{
   if(!r.month) return;
   if(!map[r.month]) map[r.month]={};
   map[r.month][r.ref]=(map[r.month][r.ref]||0)+eur(r.arr[3]);
 });

 const months=Object.keys(map).sort();
 const refs=[...new Set(DATA.map(r=>r.ref))];

 const datasets=refs.map(ref=>({
   label:ref,
   data:months.map(m=>map[m][ref]||0)
 }));

 if(chart) chart.destroy();

 chart=new Chart(chartEl,{
   type:"bar",
   data:{labels:months,datasets},
   options:{animation:false,scales:{x:{stacked:true},y:{stacked:true}}}
 });
}

/* ---------- csv load ---------- */

fetch("data.csv")
.then(r=>r.text())
.then(csv=>Papa.parse(csv,{
 skipEmptyLines:true,
 complete: res => {

   res.data.slice(2).forEach(row=>{
     if(!row[0]) return;

     DATA.push({
       f:row[0],
       ref:cleanRef(row[7]),
       month:monthKey(row[1]),
       arr:[row[0],row[1],row[2],row[3],row[6],cleanRef(row[7])]
     });
   });

   render();
   refreshRefsTab();
 }
}));

const tbody=document.getElementById("tbody");
const totalEl=document.getElementById("total");
const chartEl=document.getElementById("chart");

</script>
</body>
</html>
