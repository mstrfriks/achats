<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,Segoe UI,Arial;background:#f5f5f7;margin:40px}

.tabs button{
 padding:10px 16px;border-radius:10px;border:1px solid #ddd;
 background:white;cursor:pointer;margin-right:8px
}
.tab{display:none}
.tab.active{display:block}

.card{
 background:white;border-radius:18px;padding:20px;margin-bottom:20px;
 box-shadow:0 4px 20px rgba(0,0,0,.06)
}

input,select,button{
 padding:8px;border-radius:10px;border:1px solid #ddd;margin:4px
}

table{width:100%;border-collapse:collapse;background:white}
th,td{padding:10px;border-bottom:1px solid #eee}
th{background:#fafafa;cursor:pointer}

.filter-btn{
 padding:6px 10px;border:1px solid #ccc;border-radius:8px;
 background:white;cursor:pointer;margin:3px
}
.filter-btn.active{background:#0071e3;color:white;border-color:#0071e3}

.pagination button{
 padding:6px 10px;margin:2px;border-radius:8px;border:1px solid #ccc;background:white
}
</style>
</head>

<body>

<div class="tabs">
<button onclick="showTab('achats')">Achats</button>
<button onclick="showTab('refs')">R√©f√©rences</button>
</div>

<!-- ================= ACHATS ================= -->

<div id="achats" class="tab active">

<div class="card">
<b>Ajouter ligne</b><br>
<input id="addF" placeholder="Fournisseur">
<input id="addDate" placeholder="Date jj/mm/aaaa">
<input id="addCom" placeholder="Commentaire">
<input id="addHt" placeholder="Montant ‚Ç¨">
<input id="addType" placeholder="Type">
<select id="addRefSelect"></select>
<button onclick="addRow()">‚ûï Ajouter</button>
</div>

<div class="card">
<b>Ann√©es</b><br><div id="yearFilters"></div>
<b>Mois</b><br><div id="monthFilters"></div>
</div>

<div class="card">
Lignes par page :
<select id="pageSizeSel" onchange="setPageSize()">
<option>10</option>
<option>50</option>
<option>100</option>
</select>
</div>

<div class="card">Total : <b id="total"></b></div>
<div class="card"><canvas id="chart"></canvas></div>

<table>
<thead>
<tr>
<th onclick="setSort(0)">Fournisseur</th>
<th onclick="setSort(1)">Date</th>
<th onclick="setSort(2)">Commentaire</th>
<th onclick="setSort(3)">‚Ç¨</th>
<th onclick="setSort(4)">Type</th>
<th onclick="setSort(5)">R√©f</th>
<th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="pagination" id="pager"></div>

</div>

<!-- ================= REFERENCES ================= -->

<div id="refs" class="tab">

<div class="card">
<input id="newRefCode" placeholder="Code">
<input id="newRefName" placeholder="D√©signation">
<button onclick="addReference()">‚ûï Ajouter</button>
</div>

<div class="card">
<table>
<thead><tr><th>Code</th><th>D√©signation</th><th></th></tr></thead>
<tbody id="refBody"></tbody>
</table>
</div>

</div>

<script>

/* ---------- tabs ---------- */

function showTab(id){
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"))
 document.getElementById(id).classList.add("active")
}

/* ---------- utils ---------- */

const eur=v=>parseFloat((v||"").replace(/[^\d,.-]/g,"").replace(",", "."))||0
const cleanRef=v=>(v||"").trim()||"Sans r√©f√©rence"

function parseDate(d){
 if(!d||!d.includes("/")) return {}
 const [j,m,a]=d.split("/")
 return {j:+j,m:+m,a:+a}
}

function monthKey(d){
 const p=parseDate(d)
 if(!p.a) return null
 return p.a+"-"+String(p.m).padStart(2,"0")
}

function dateVal(d){
 const p=parseDate(d)
 return p.a ? new Date(p.a,p.m-1,p.j).getTime() : 0
}

/* ---------- refs ---------- */

const REF_KEY="refs_v6"
let REFS=JSON.parse(localStorage.getItem(REF_KEY)||"{}")
function saveRefs(){localStorage.setItem(REF_KEY,JSON.stringify(REFS))}
function ensureRef(c){if(!REFS[c]) REFS[c]=""}

function refreshRefUI(){
 refBody.innerHTML=Object.entries(REFS).map(([c,n])=>`
 <tr>
  <td contenteditable onblur="editRefCode('${c}',this.innerText)">${c}</td>
  <td contenteditable onblur="editRefName('${c}',this.innerText)">${n}</td>
  <td><button onclick="deleteRef('${c}')">üóë</button></td>
 </tr>`).join("")
 addRefSelect.innerHTML=Object.keys(REFS).map(c=>`<option>${c}</option>`).join("")
 saveRefs()
}

function addReference(){
 const c=newRefCode.value.trim()
 if(!c||REFS[c]){alert("Code invalide");return}
 REFS[c]=newRefName.value.trim()
 refreshRefUI()
}

function editRefName(c,v){REFS[c]=v.trim();saveRefs()}

function editRefCode(oldC,newC){
 newC=newC.trim()
 if(!newC||(newC!==oldC&&REFS[newC])){alert("Doublon");refreshRefUI();return}
 REFS[newC]=REFS[oldC]; delete REFS[oldC]
 DATA.forEach(r=>{if(r.ref===oldC){r.ref=newC;r.arr[5]=newC}})
 refreshRefUI(); render()
}

function deleteRef(c){
 if(!confirm("Supprimer ?")) return
 delete REFS[c]
 DATA.forEach(r=>{if(r.ref===c){r.ref="Sans r√©f√©rence";r.arr[5]=r.ref}})
 refreshRefUI(); render()
}

/* ---------- data ---------- */

let DATA=[]
let chart

/* ---------- filters ---------- */

const MONTHS=["Jan","F√©v","Mar","Avr","Mai","Jun","Jul","Ao√ª","Sep","Oct","Nov","D√©c"]
let selYears=new Set(), selMonths=new Set()

function toggleYear(y){selYears.has(y)?selYears.delete(y):selYears.add(y);render();renderYearBtns()}
function toggleMonth(m){selMonths.has(m)?selMonths.delete(m):selMonths.add(m);render();renderMonthBtns()}

function renderYearBtns(){
 const ys=[...new Set(DATA.map(x=>x.y).filter(Boolean))].sort()
 yearFilters.innerHTML=ys.map(y=>btn(y,selYears.has(y),`toggleYear(${y})`)).join("")
}

function renderMonthBtns(){
 monthFilters.innerHTML=MONTHS.map((n,i)=>btn(n,selMonths.has(i+1),`toggleMonth(${i+1})`)).join("")
}

function btn(label,on,fn){
 return `<button class="filter-btn ${on?"active":""}" onclick="${fn}">${label}</button>`
}

function passTime(r){
 if(selYears.size && !selYears.has(r.y)) return false
 if(selMonths.size && !selMonths.has(r.m)) return false
 return true
}

/* ---------- sorting ---------- */

let sortCol=1
let sortDir=-1   // r√©cent d'abord

function setSort(col){
 if(col===1){
   sortDir*=-1
 }else{
   sortCol=col
   sortDir=1
 }
 render()
}

function sortRows(rows){

 rows.sort((a,b)=>{

  // TRI PRINCIPAL = DATE DESC
  const d = dateVal(b.arr[1]) - dateVal(a.arr[1])
  if(d!==0) return d

  // TRI SECONDAIRE
  const A=a.arr[sortCol]
  const B=b.arr[sortCol]

  if(sortCol===3) return (eur(A)-eur(B))*sortDir
  if(sortCol===1) return (dateVal(A)-dateVal(B))*sortDir

  return A.localeCompare(B,"fr")*sortDir
 })
}

/* ---------- pagination ---------- */

let pageSize=10, curPage=1

function setPageSize(){
 pageSize=parseInt(pageSizeSel.value)
 curPage=1
 render()
}

function renderPager(total){
 const pages=Math.ceil(total/pageSize)||1
 pager.innerHTML=Array.from({length:pages},(_,i)=>
  `<button onclick="curPage=${i+1};render()">${i+1}</button>`
 ).join("")
}

/* ---------- achats ---------- */

function addRow(){
 const f=addF.value.trim()
 const d=addDate.value.trim()
 const c=addCom.value.trim()
 const ht=addHt.value.trim()
 const t=addType.value.trim()
 const r=addRefSelect.value
 if(!f||!d||!ht){alert("Champs requis");return}
 const p=parseDate(d)
 DATA.push({arr:[f,d,c,ht,t,r],ref:r,month:monthKey(d),y:p.a,m:p.m})
 render(); renderYearBtns()
}

/* ---------- edit rows ---------- */

function editRow(i){
 const r=DATA[i].arr
 tbody.children[i].innerHTML=`
<td><input value="${r[0]}"></td>
<td><input value="${r[1]}"></td>
<td><input value="${r[2]}"></td>
<td><input value="${r[3]}"></td>
<td><input value="${r[4]}"></td>
<td>${refSel(r[5])}</td>
<td><button onclick="saveRow(${i})">üíæ</button></td>`
}

function refSel(sel){
 return `<select>${
  Object.keys(REFS).map(k=>`<option ${k===sel?"selected":""}>${k}</option>`).join("")
 }</select>`
}

function saveRow(i){
 const cells=tbody.children[i].querySelectorAll("input,select")
 const a=[...cells].map(x=>x.value)
 const p=parseDate(a[1])
 DATA[i]={arr:a,ref:a[5],month:monthKey(a[1]),y:p.a,m:p.m}
 render()
}

function deleteRow(i){
 if(!confirm("Supprimer ligne ?")) return
 DATA.splice(i,1)
 render()
}

/* ---------- render ---------- */

function render(){

 const rows=DATA.filter(passTime)
 sortRows(rows)

 const total=rows.reduce((s,r)=>s+eur(r.arr[3]),0)
 totalEl.textContent=total.toLocaleString()+" ‚Ç¨"

 renderPager(rows.length)

 const start=(curPage-1)*pageSize
 const pageRows=rows.slice(start,start+pageSize)

 tbody.innerHTML=pageRows.map(r=>{
  const i=DATA.indexOf(r)
  return `<tr>
   ${r.arr.map(v=>`<td>${v}</td>`).join("")}
   <td>
    <button onclick="editRow(${i})">‚úèÔ∏è</button>
    <button onclick="deleteRow(${i})">üóë</button>
   </td></tr>`
 }).join("")

 buildChart(rows)
}

/* ---------- chart ---------- */

function buildChart(rows){

 const map={}
 rows.forEach(r=>{
  if(!r.month) return
  if(!map[r.month]) map[r.month]={}
  map[r.month][r.ref]=(map[r.month][r.ref]||0)+eur(r.arr[3])
 })

 const months=Object.keys(map).sort()
 const refs=[...new Set(rows.map(r=>r.ref))]

 const datasets=refs.map(ref=>({
  label:ref,
  data:months.map(m=>map[m][ref]||0)
 }))

 if(chart) chart.destroy()
 chart=new Chart(chartEl,{
  type:"bar",
  data:{labels:months,datasets},
  options:{animation:false,scales:{x:{stacked:true},y:{stacked:true}}}
 })
}

/* ---------- load csv ---------- */

fetch("data.csv")
.then(r=>r.text())
.then(csv=>Papa.parse(csv,{
 skipEmptyLines:true,
 complete: res=>{
  res.data.slice(2).forEach(row=>{
   if(!row[0]) return
   const ref=cleanRef(row[7])
   ensureRef(ref)
   const p=parseDate(row[1])
   DATA.push({
    arr:[row[0],row[1],row[2],row[3],row[6],ref],
    ref,month:monthKey(row[1]),y:p.a,m:p.m
   })
  })
  refreshRefUI()
  renderYearBtns()
  renderMonthBtns()
  render()
 }
}))

const tbody=document.getElementById("tbody")
const totalEl=document.getElementById("total")
const chartEl=document.getElementById("chart")

</script>
</body>
</html>
