<script>

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS80EbOdyJxdT8hmQAux0KJXM-LHsGKFP5eEGQuo28JFid6CwEVCApcOJ-0GpncdDul4Q97VvmjdmTm/pub?output=csv";

let table;

function toNumber(v){
 if(!v) return 0;
 return parseFloat(v.replace(",",".").replace(" ","")) || 0;
}

Papa.parse(csvUrl, {
 download: true,
 skipEmptyLines: true,

 complete: function(results){

   const rows = results.data;
   rows.shift(); // enlève header

   const fournisseurs = new Set();
   const refs = new Set();

   rows.forEach(r => {

     const date = r[0];
     const fournisseur = r[1];
     const type = r[3];
     const ref = r[5];
     const ht = r[4];

     fournisseurs.add(fournisseur);
     refs.add(ref);

     $("#table tbody").append(`
       <tr>
         <td>${date}</td>
         <td>${fournisseur}</td>
         <td>${type}</td>
         <td>${ref}</td>
         <td>${ht}</td>
       </tr>
     `);
   });

   fournisseurs.forEach(f => $("#fournisseurFilter").append(`<option>${f}</option>`));
   refs.forEach(r => $("#refFilter").append(`<option>${r}</option>`));

   table = $('#table').DataTable({
     pageLength: 25,
     order:[[0,"desc"]]
   });

   updateTotal();
 }
});

function updateTotal(){
 let sum = 0;
 table.rows({search:'applied'}).every(function(){
   sum += toNumber(this.data()[4]);
 });
 $("#total").text(sum.toLocaleString()+" €");
}

$("#fournisseurFilter").on("change", function(){
 table.column(1).search(this.value).draw();
});

$("#refFilter").on("change", function(){
 table.column(3).search(this.value).draw();
});

$('#table').on('draw.dt', updateTotal);

</script>
