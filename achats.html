<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi Achats</title>

<link rel="stylesheet"
 href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; margin:20px; }
.filters select { padding:5px; margin-right:10px; }
.kpi { font-size:20px; font-weight:bold; margin:15px 0; }
</style>
</head>

<body>

<h2>ðŸ“Š Suivi des achats</h2>

<div class="filters">
<select id="fournisseurFilter">
<option value="">Tous fournisseurs</option>
</select>

<select id="refFilter">
<option value="">Toutes rÃ©fÃ©rences</option>
</select>
</div>

<div class="kpi">
Total HT filtrÃ© : <span id="total">0 â‚¬</span>
</div>

<table id="table" class="display">
<thead>
<tr>
<th>Date</th>
<th>Fournisseur</th>
<th>Type doc</th>
<th>RÃ©f gestion</th>
<th>â‚¬ HT</th>
</tr>
</thead>
<tbody></tbody>
</table>

<canvas id="chart" height="120"></canvas>

<script>

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS80EbOdyJxdT8hmQAux0KJXM-LHsGKFP5eEGQuo28JFid6CwEVCApcOJ-0GpncdDul4Q97VvmjdmTm/pub?output=csv";

let table;

function toNumber(v){
 if(!v) return 0;
 return parseFloat(v.replace(",", ".").replace(" ", "")) || 0;
}

Papa.parse(csvUrl, {
 download: true,
 header: true,
 skipEmptyLines: true,

 complete: function(results){

   const data = results.data;
   const fournisseurs = new Set();
   const refs = new Set();

   data.forEach(r => {

     const date = r["DATE"] || r["Date"];
     const fournisseur = r["NOM"] || r["Fournisseur"] || "";
     const type = r["Type doc"] || "";
     const ref = r["RÃ©f Gestion"] || "";
     const ht = r["â‚¬ HT"] || r["HT"] || "";

     fournisseurs.add(fournisseur);
     refs.add(ref);

     $("#table tbody").append(`
       <tr>
         <td>${date}</td>
         <td>${fournisseur}</td>
         <td>${type}</td>
         <td>${ref}</td>
         <td>${ht}</td>
       </tr>
     `);
   });

   fournisseurs.forEach(f => $("#fournisseurFilter").append(`<option>${f}</option>`));
   refs.forEach(r => $("#refFilter").append(`<option>${r}</option>`));

   table = $('#table').DataTable({
     pageLength: 25,
     order: [[0,"desc"]]
   });

   updateTotal();
   buildChart();
 }
});

function updateTotal(){
 let sum = 0;
 table.rows({search:'applied'}).every(function(){
   sum += toNumber(this.data()[4]);
 });
 $("#total").text(sum.toLocaleString()+" â‚¬");
}

function buildChart(){
 let map = {};

 table.rows({search:'applied'}).every(function(){
   const r = this.data();
   map[r[1]] = (map[r[1]] || 0) + toNumber(r[4]);
 });

 new Chart(document.getElementById("chart"), {
   type: "bar",
   data: {
     labels: Object.keys(map),
     datasets: [{label:"â‚¬ HT", data:Object.values(map)}]
   }
 });
}

$("#fournisseurFilter").on("change", function(){
 table.column(1).search(this.value).draw();
});

$("#refFilter").on("change", function(){
 table.column(3).search(this.value).draw();
});

$('#table').on('draw.dt', function(){
 updateTotal();
});

</script>

</body>
</html>
