<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi achats</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>

<style>
body{font-family:-apple-system,Segoe UI,Arial;background:#f5f5f7;margin:40px}
.card{background:white;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
select{padding:10px;border-radius:10px;border:1px solid #ddd}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee}
th{background:#fafafa;cursor:pointer}
#debug{font-family:monospace;font-size:12px;color:#666}
</style>
</head>

<body>

<h2>ðŸ“Š Suivi des achats</h2>

<div class="card">
<select id="fFilter"><option value="">Tous fournisseurs</option></select>
<select id="tFilter"><option value="">Tous types</option></select>
</div>

<div class="card">
Total HT : <b id="total">0 â‚¬</b>
</div>

<div id="debug" class="card">debug: dÃ©marrageâ€¦</div>

<table>
<thead>
<tr>
<th data-col="0">Fournisseur</th>
<th data-col="1">Date</th>
<th data-col="2">Commentaire</th>
<th data-col="3">â‚¬ HT</th>
<th data-col="4">Type doc</th>
<th data-col="5">RÃ©f gestion</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>

const URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS80EbOdyJxdT8hmQAux0KJXM-LHsGKFP5eEGQuo28JFid6CwEVCApcOJ-0GpncdDul4Q97VvmjdmTm/pub?output=csv";

function log(x){ debug.innerText += "\n"+x }

function eur(v){
 return parseFloat((v||"").replace(/[â‚¬\s]/g,"").replace(",", "."))||0
}

function norm(s){ return (s||"").trim().toLowerCase() }

let DATA=[]
let sortCol=1, sortDir=-1

function render(){
 const f=norm(fFilter.value)
 const t=norm(tFilter.value)

 const rows = DATA.filter(r =>
   (!f || norm(r.f)===f) &&
   (!t || norm(r.t)===t)
 )

 rows.sort((a,b)=>{
   const A=a.arr[sortCol], B=b.arr[sortCol]
   if(sortCol===3) return (eur(A)-eur(B))*sortDir
   return A.localeCompare(B)*sortDir
 })

 tbody.innerHTML=""
 let total=0

 rows.forEach(r=>{
   total+=eur(r.arr[3])
   tbody.innerHTML += "<tr>"+r.arr.map(x=>`<td>${x}</td>`).join("")+"</tr>"
 })

 totalEl.innerText = total.toLocaleString()+" â‚¬"
}

Papa.parse(URL,{
 download:true,
 skipEmptyLines:true,
 complete: res => {

   log("lignes csv: "+res.data.length)

   // ðŸ”Ž trouve header
   const headerRow = res.data.find(r =>
     r.join(" ").toLowerCase().includes("date") &&
     r.join(" ").toLowerCase().includes("fourn")
   )

   if(!headerRow){ log("HEADER NON TROUVÃ‰"); return }

   log("header dÃ©tectÃ©: "+headerRow.join(" | "))

   const idx = {
     fournisseur: headerRow.findIndex(c=>/fourn/i.test(c)),
     date: headerRow.findIndex(c=>/date/i.test(c)),
     comm: headerRow.findIndex(c=>/comment/i.test(c)),
     ht: headerRow.findIndex(c=>/charge|â‚¬|ht/i.test(c)),
     type: headerRow.findIndex(c=>/type/i.test(c)),
     ref: headerRow.findIndex(c=>/rÃ©f|ref/i.test(c))
   }

   log("index colonnes: "+JSON.stringify(idx))

   const start = res.data.indexOf(headerRow)+1

   const fset=new Set()
   const tset=new Set()

   res.data.slice(start).forEach(r=>{
     if(!r[idx.fournisseur]) return

     const row = {
       f:r[idx.fournisseur],
       t:r[idx.type],
       arr:[
         r[idx.fournisseur],
         r[idx.date],
         r[idx.comm],
         r[idx.ht],
         r[idx.type],
         r[idx.ref]
       ]
     }

     DATA.push(row)
     fset.add(row.f)
     tset.add(row.t)
   })

   log("lignes utiles: "+DATA.length)

   fset.forEach(v=>fFilter.innerHTML+=`<option>${v}</option>`)
   tset.forEach(v=>tFilter.innerHTML+=`<option>${v}</option>`)

   render()
 }
})

fFilter.onchange=render
tFilter.onchange=render

document.querySelectorAll("th").forEach(th=>{
 th.onclick=()=>{ sortCol=+th.dataset.col; sortDir*=-1; render() }
})

</script>

</body>
</html>
