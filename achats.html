<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi achats</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
 background:#f5f5f7;
 margin:40px;
 color:#1d1d1f;
}
.card{
 background:white;
 border-radius:18px;
 padding:20px;
 margin-bottom:20px;
 box-shadow:0 4px 20px rgba(0,0,0,.06);
}
select{padding:10px;border-radius:12px;border:1px solid #ddd;margin-right:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eee}
th{cursor:pointer;background:#fafafa}
.kpi{font-size:22px;font-weight:600}
</style>
</head>

<body>

<h2>ðŸ“Š Suivi des achats</h2>

<div class="card">
<select id="fFilter"><option value="">Tous fournisseurs</option></select>
<select id="rFilter"><option value="">Toutes rÃ©fÃ©rences</option></select>
<select id="mFilter"><option value="">Tous mois</option></select>
</div>

<div class="card kpi">
Total HT filtrÃ© : <span id="total">0 â‚¬</span>
</div>

<div class="card">
<canvas id="chart" height="120"></canvas>
</div>

<table>
<thead>
<tr>
<th data-col="0">Fournisseur</th>
<th data-col="1">Date</th>
<th data-col="2">Commentaire</th>
<th data-col="3">â‚¬ HT</th>
<th data-col="4">Type doc</th>
<th data-col="5">RÃ©f gestion</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>

const URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS80EbOdyJxdT8hmQAux0KJXM-LHsGKFP5eEGQuo28JFid6CwEVCApcOJ-0GpncdDul4Q97VvmjdmTm/pub?output=csv";

function eur(v){
 return parseFloat(v.replace(/[^\d,.-]/g,"").replace(",", ".")) || 0
}

function norm(s){ return (s||"").trim().toLowerCase() }

function monthKey(d){
 const [j,m,a] = d.split("/")
 return a+"-"+m
}

let DATA=[]
let sortCol=1, sortDir=-1
let chart

function render(){

 const f = norm(fFilter.value)
 const r = norm(rFilter.value)
 const m = mFilter.value

 const rows = DATA.filter(x =>
   (!f || norm(x.f)===f) &&
   (!r || norm(x.ref)===r) &&
   (!m || x.month===m)
 )

 rows.sort((a,b)=>{
   if(sortCol===3) return (eur(a.arr[3])-eur(b.arr[3]))*sortDir
   return a.arr[sortCol].localeCompare(b.arr[sortCol])*sortDir
 })

 tbody.innerHTML=""
 let total=0

 rows.forEach(x=>{
   total+=eur(x.arr[3])
   tbody.innerHTML += "<tr>"+x.arr.map(c=>`<td>${c}</td>`).join("")+"</tr>"
 })

 totalEl.textContent = total.toLocaleString()+" â‚¬"

 buildChart(rows)
}

function buildChart(rows){

 const map = {}

 rows.forEach(r=>{
   const k = r.month
   if(!map[k]) map[k]={}
   map[k][r.ref] = (map[k][r.ref]||0) + eur(r.arr[3])
 })

 const months = Object.keys(map).sort()
 const refs = [...new Set(rows.map(r=>r.ref))]

 const datasets = refs.map(ref => ({
   label: ref,
   data: months.map(m => map[m][ref]||0)
 }))

 if(chart) chart.destroy()

 chart = new Chart(chartEl,{
   type:"bar",
   data:{ labels:months, datasets },
   options:{
     responsive:true,
     plugins:{ legend:{ position:"bottom" } },
     scales:{ x:{ stacked:true }, y:{ stacked:true } }
   }
 })
}

Papa.parse(URL,{
 download:true,
 skipEmptyLines:true,
 complete: res => {

   const header = res.data.find(r =>
     r.join(" ").toLowerCase().includes("date") &&
     r.join(" ").toLowerCase().includes("fourn")
   )

   const idx = {
     f: header.findIndex(c=>/fourn/i.test(c)),
     d: header.findIndex(c=>/date/i.test(c)),
     c: header.findIndex(c=>/comment/i.test(c)),
     h: header.findIndex(c=>/charge|ht/i.test(c)),
     t: header.findIndex(c=>/type/i.test(c)),
     r: header.findIndex(c=>/rÃ©f|ref/i.test(c))
   }

   const body = res.data.slice(res.data.indexOf(header)+1)

   const fset=new Set(), rset=new Set(), mset=new Set()

   body.forEach(row=>{
     if(!row[idx.f]) return

     const d = row[idx.d]
     const m = monthKey(d)

     const obj = {
       f: row[idx.f],
       ref: row[idx.r],
       month: m,
       arr:[
         row[idx.f],
         d,
         row[idx.c],
         row[idx.h],
         row[idx.t],
         row[idx.r]
       ]
     }

     DATA.push(obj)
     fset.add(obj.f)
     rset.add(obj.ref)
     mset.add(m)
   })

   ;[...fset].sort().forEach(v=>fFilter.innerHTML+=`<option>${v}</option>`)
   ;[...rset].sort().forEach(v=>rFilter.innerHTML+=`<option>${v}</option>`)
   ;[...mset].sort().forEach(v=>mFilter.innerHTML+=`<option>${v}</option>`)

   render()
 }
})

fFilter.onchange=render
rFilter.onchange=render
mFilter.onchange=render

document.querySelectorAll("th").forEach(th=>{
 th.onclick=()=>{ sortCol=+th.dataset.col; sortDir*=-1; render() }
})

const tbody=document.getElementById("tbody")
const totalEl=document.getElementById("total")
const chartEl=document.getElementById("chart")
const fFilter=document.getElementById("fFilter")
const rFilter=document.getElementById("rFilter")
const mFilter=document.getElementById("mFilter")

</script>

</body>
</html>
