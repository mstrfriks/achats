<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>

body{
 font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Arial;
 background:#f5f5f7;
 margin:40px;
 color:#1d1d1f;
}

h1{
 font-weight:600;
 font-size:28px;
 margin-bottom:20px;
}

.card{
 background:white;
 border-radius:18px;
 padding:20px;
 box-shadow:0 4px 20px rgba(0,0,0,0.06);
 margin-bottom:20px;
}

.filters{
 display:flex;
 gap:12px;
}

select{
 padding:10px 14px;
 border-radius:12px;
 border:1px solid #ddd;
 background:white;
 font-size:14px;
}

.kpi{
 font-size:22px;
 font-weight:600;
}

table.dataTable{
 border:none !important;
}

.dataTables_wrapper{
 background:white;
 border-radius:18px;
 padding:20px;
 box-shadow:0 4px 20px rgba(0,0,0,0.06);
}

</style>
</head>

<body>

<h1>ðŸ“Š Suivi des achats</h1>

<div class="card">
<div class="filters">
<select id="fournisseurFilter">
<option value="">Tous fournisseurs</option>
</select>

<select id="typeFilter">
<option value="">Tous types doc</option>
</select>
</div>
</div>

<div class="card">
<div class="kpi">
Total HT filtrÃ© : <span id="total">0 â‚¬</span>
</div>
</div>

<table id="t" class="display">
<thead>
<tr>
<th>Fournisseur</th>
<th>Date</th>
<th>Commentaire</th>
<th>â‚¬ HT</th>
<th>Type doc</th>
<th>RÃ©f gestion</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS80EbOdyJxdT8hmQAux0KJXM-LHsGKFP5eEGQuo28JFid6CwEVCApcOJ-0GpncdDul4Q97VvmjdmTm/pub?output=csv";

function eur(v){
 if(!v) return 0;
 return parseFloat(v.replace(/[â‚¬\s]/g,"").replace(",", ".")) || 0;
}

function escapeRegex(text){
 return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

Papa.parse(url,{
 download:true,
 skipEmptyLines:true,

 complete: res => {

   const rows = res.data.slice(2);

   const fset=new Set();
   const tset=new Set();

   rows.forEach(r=>{

     if(!r[0]) return;

     $("#t tbody").append(`
     <tr>
       <td>${r[0]}</td>
       <td>${r[1]}</td>
       <td>${r[2]}</td>
       <td>${r[3]}</td>
       <td>${r[6]}</td>
       <td>${r[7]}</td>
     </tr>`);

     fset.add(r[0]);
     tset.add(r[6]);
   });

   [...fset].sort().forEach(v=>$("#fournisseurFilter").append(`<option>${v}</option>`));
   [...tset].sort().forEach(v=>$("#typeFilter").append(`<option>${v}</option>`));

   window.dt = $('#t').DataTable({
     pageLength:25,
     order:[[1,"desc"]],
     language:{ search:"Recherche :" }
   });

   updateTotal();
 }
});

function updateTotal(){
 let s=0;
 dt.rows({search:'applied'}).every(function(){
   s+=eur(this.data()[3]);
 });
 $("#total").text(s.toLocaleString()+" â‚¬");
}

$("#fournisseurFilter").on("change", function(){
 const v=this.value;
 dt.column(0).search(v ? "^"+escapeRegex(v)+"$" : "", true,false).draw();
});

$("#typeFilter").on("change", function(){
 const v=this.value;
 dt.column(4).search(v ? "^"+escapeRegex(v)+"$" : "", true,false).draw();
});

$('#t').on('draw.dt', updateTotal);

</script>

</body>
</html>
