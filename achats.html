<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Suivi des achats</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>

<style>
body{
 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
 background:#f5f5f7;
 margin:40px;
 color:#1d1d1f;
}
.card{
 background:white;
 border-radius:18px;
 padding:20px;
 margin-bottom:20px;
 box-shadow:0 4px 20px rgba(0,0,0,0.06);
}
select{padding:10px;border-radius:12px;border:1px solid #ddd}
table{width:100%;border-collapse:collapse;background:white;border-radius:18px;overflow:hidden}
th,td{padding:12px;border-bottom:1px solid #eee}
th{cursor:pointer;background:#fafafa}
.kpi{font-size:22px;font-weight:600}
</style>
</head>

<body>

<h1>ðŸ“Š Suivi des achats</h1>

<div class="card">
<select id="fFilter"><option value="">Tous fournisseurs</option></select>
<select id="tFilter"><option value="">Tous types doc</option></select>
</div>

<div class="card kpi">
Total HT filtrÃ© : <span id="total">0 â‚¬</span>
</div>

<table>
<thead>
<tr>
<th data-col="0">Fournisseur</th>
<th data-col="1">Date</th>
<th data-col="2">Commentaire</th>
<th data-col="3">â‚¬ HT</th>
<th data-col="4">Type doc</th>
<th data-col="5">RÃ©f gestion</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>

const URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS80EbOdyJxdT8hmQAux0KJXM-LHsGKFP5eEGQuo28JFid6CwEVCApcOJ-0GpncdDul4Q97VvmjdmTm/pub?output=csv";

function eur(v){
 return parseFloat((v||"").replace(/[â‚¬\s]/g,"").replace(",", ".")) || 0;
}

function norm(s){
 return (s||"").trim().toLowerCase();
}

let rows=[];
let sortCol=1;
let sortDir=-1;

function render(){

 const f = norm(fFilter.value);
 const t = norm(tFilter.value);

 const out = rows.filter(r =>
   (!f || norm(r[0])===f) &&
   (!t || norm(r[4])===t)
 );

 out.sort((a,b)=>{
   if(sortCol===3) return (eur(a[3])-eur(b[3]))*sortDir;
   return a[sortCol].localeCompare(b[sortCol])*sortDir;
 });

 tbody.innerHTML="";
 let total=0;

 out.forEach(r=>{
   total+=eur(r[3]);
   tbody.innerHTML += `<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`;
 });

 totalEl.textContent = total.toLocaleString()+" â‚¬";
}

Papa.parse(URL,{
 download:true,
 skipEmptyLines:true,
 complete: res => {

   const data = res.data;

   // ðŸ”Ž dÃ©tecte ligne dâ€™en-tÃªte
   const headerIndex = data.findIndex(r =>
     r.join(" ").toLowerCase().includes("date") &&
     r.join(" ").toLowerCase().includes("fourn")
   );

   const body = data.slice(headerIndex+1);

   const fset=new Set();
   const tset=new Set();

   body.forEach(r=>{
     if(!r[0]) return;

     const row=[r[0],r[1],r[2],r[3],r[6],r[7]];
     rows.push(row);
     fset.add(r[0]);
     tset.add(r[6]);
   });

   [...fset].sort().forEach(v=>fFilter.innerHTML+=`<option>${v}</option>`);
   [...tset].sort().forEach(v=>tFilter.innerHTML+=`<option>${v}</option>`);

   render();
 }
});

fFilter.onchange=render;
tFilter.onchange=render;

document.querySelectorAll("th").forEach(th=>{
 th.onclick=()=>{
   sortCol=+th.dataset.col;
   sortDir*=-1;
   render();
 };
});

const fFilter=document.getElementById("fFilter");
const tFilter=document.getElementById("tFilter");
const tbody=document.getElementById("tbody");
const totalEl=document.getElementById("total");

</script>

</body>
</html>
